import autogen
import os
from dotenv import load_dotenv

from old.llms import gemini_llm
from tools import save_feature, save_testcase

from autogen_agentchat.agents import AssistantAgent, UserProxyAgent
# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# LLM é…ç½®
config_list = [
    {
        "model": os.getenv("OPENAI_MODEL", "gpt-4o"),
        "api_key": os.getenv("OPENAI_API_KEY")
    }
]

llm_config = {
    "config_list": config_list,
    "temperature": 0.1,
    "functions": [
        {
            "name": "save_feature",
            "description": "å°†è§£æçš„éœ€æ±‚åŠŸèƒ½ç‚¹ä¿å­˜åˆ°æ•°æ®åº“ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "description": {"type": "string"}
                },
                "required": ["name", "description"]
            }
        },
        {
            "name": "save_testcase",
            "description": "å°†ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ä¿å­˜åˆ°æ•°æ®åº“ã€‚",
            "parameters": {
                "type": "object",
                "properties": {
                    "feature_id": {"type": "integer"},
                    "title": {"type": "string"},
                    "steps": {"type": "string"},
                    "expected": {"type": "string"}
                },
                "required": ["feature_id", "title", "steps", "expected"]
            }
        }
    ]
}

# åˆ›å»ºç”¨æˆ·ä»£ç†
user_proxy = UserProxyAgent(
    name="User_Proxy",
    human_input_mode="NEVER",
    code_execution_config=False,  # æˆ‘ä»¬åªä½¿ç”¨å‡½æ•°è°ƒç”¨ï¼Œä¸æ‰§è¡Œä»£ç 
    function_map={
        "save_feature": save_feature,
        "save_testcase": save_testcase
    }
)

# åˆ›å»ºéœ€æ±‚åˆ†æå¸ˆä»£ç†ç”¨äºéœ€æ±‚åˆ†æ
analyst_agent = AssistantAgent(
    name="Analyst",
    system_message="""ä½ æ˜¯ä¸€ä¸ªéœ€æ±‚åˆ†æå¸ˆã€‚
    ä»»åŠ¡ï¼šé˜…è¯»ç”¨æˆ·æä¾›çš„éœ€æ±‚æ–‡æ¡£ï¼Œå¹¶å°†å…¶æ‹†è§£ä¸ºç‹¬ç«‹çš„åŠŸèƒ½ç‚¹ã€‚
    è§„åˆ™ï¼šå¯¹äºæ¯ä¸ªè¯†åˆ«å‡ºçš„åŠŸèƒ½ç‚¹ï¼Œå¿…é¡»ç«‹å³è°ƒç”¨ 'save_feature' å·¥å…·å°†å…¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚
    ä¸è¦å›å¤ç¡®è®¤ä¿¡æ¯ï¼Œåªéœ€è¦è°ƒç”¨å·¥å…·ã€‚""",
    model_client=gemini_llm
)

requirement_analysis_agent = AssistantAgent(
    name='requirement_analysis_agent',
    model_client=gemini_llm,
    tools=[save_feature],
    system_message="""
            æ ¹æ®å¾—åˆ°çš„éœ€æ±‚æ–‡æ¡£ï¼Œè¿›è¡Œéœ€æ±‚åˆ†æï¼Œè¾“å‡ºéœ€æ±‚åˆ†ææŠ¥å‘Šï¼š

                ## 1. Profile
                **è§’è‰²**ï¼šé«˜çº§æµ‹è¯•éœ€æ±‚åˆ†æå¸ˆ  
                **æ ¸å¿ƒèƒ½åŠ›**ï¼š
                - éœ€æ±‚ç»“æ„åŒ–æ‹†è§£ä¸å¯æµ‹è¯•æ€§è½¬åŒ–
                - é£é™©é©±åŠ¨çš„æµ‹è¯•ç­–ç•¥è®¾è®¡
                - å…¨é“¾è·¯éœ€æ±‚è¿½æº¯èƒ½åŠ›

                ## 2. éœ€æ±‚ç»“æ„åŒ–æ¡†æ¶
                ### 2.1 åŠŸèƒ½éœ€æ±‚åˆ†è§£
                ```markdown
                - [å¿…é€‰] ä½¿ç”¨Markdownæ— åºåˆ—è¡¨å±•ç¤ºåŠŸèƒ½æ¨¡å—
                - [å¿…é€‰] æ ‡æ³¨è§„åˆ™ï¼š
                  - æ ¸å¿ƒåŠŸèƒ½ï¼šâ˜…ï¼ˆå½±å“æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼‰
                  - é«˜é£é™©åŠŸèƒ½ï¼šâš ï¸ï¼ˆå«å¤–éƒ¨ä¾èµ–/å¤æ‚é€»è¾‘ï¼‰
                - ç¤ºä¾‹ï¼š
                  - è®¢å•é£æ§å¼•æ“ï¼ˆâ˜…âš ï¸ï¼‰ï¼šå®æ—¶äº¤æ˜“é£é™©è¯„ä¼°

            ### 2.2 éåŠŸèƒ½éœ€æ±‚çŸ©é˜µ

            ```markdown
            | ç»´åº¦       | æŒ‡æ ‡é¡¹                 | éªŒæ”¶æ ‡å‡†            |
            |------------|------------------------|---------------------|
            | æ€§èƒ½       | æ”¯ä»˜æ¥å£å“åº”æ—¶é—´       | â‰¤1.2s(P99)         |
            | å®‰å…¨æ€§     | æ•æ„Ÿä¿¡æ¯åŠ å¯†           | AES-256+SSL/TLS1.3 |
            ```

            ### 2.3 ä¸šåŠ¡è§„åˆ™æå–æ¨¡æ¿

            ```markdown
            - è§„åˆ™ç¼–å·ï¼šBR-{æ¨¡å—ç¼©å†™}-001
            - è§¦å‘æ¡ä»¶ï¼šå½“[æ¡ä»¶]æ—¶
            - ç³»ç»Ÿè¡Œä¸ºï¼šåº”æ‰§è¡Œ[åŠ¨ä½œ]
            - ç¤ºä¾‹ï¼š
              BR-PAY-003ï¼šå½“è¿ç»­éªŒè¯å¤±è´¥3æ¬¡æ—¶ï¼Œé”å®šè´¦æˆ·1å°æ—¶
            ```

            ## 3. æ·±åº¦åˆ†ææŒ‡ä»¤

            ### 3.1 å¯æµ‹è¯•æ€§è¯„ä¼°è¡¨

            ```markdown
            | éœ€æ±‚ID | å¯æµ‹æ€§(1-5) | ç¼ºé™·æè¿°               | ä¼˜åŒ–å»ºè®®            |
            |--------|-------------|------------------------|---------------------|
            | F-012  | 2           | "è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ"æ— é‡åŒ– | å¢åŠ é¡µé¢åŠ è½½è¿›åº¦æ¡ |
            ```

            ### 3.2 æµ‹è¯•ç­–ç•¥è“å›¾

            ```markdown
            - [åˆ†å±‚ç­–ç•¥] 
              â–ˆ å•å…ƒæµ‹è¯•(30%) â†’ æ¥å£æµ‹è¯•(40%) â†’ E2Eæµ‹è¯•(20%) â†’ æ¢ç´¢æµ‹è¯•(10%)
            - [å·¥å…·é“¾] 
              Jest(å•å…ƒ) + Postman(æ¥å£) + Cypress(E2E) + OWASP ZAP(å®‰å…¨)
            ```

            ### 3.3 é£é™©çƒ­ç‚¹åœ°å›¾

            ```markdown
            ğŸ”¥ é«˜é£é™©åŒºï¼ˆç«‹å³å¤„ç†ï¼‰ï¼š
            - ç¬¬ä¸‰æ–¹èº«ä»½è®¤è¯æœåŠ¡é™çº§
            - æ”¯ä»˜é‡‘é¢è®¡ç®—ç²¾åº¦ä¸¢å¤±

            ğŸ›¡ï¸ ç¼“è§£æªæ–½ï¼š
            - å®æ–½æ¥å£mockæ–¹æ¡ˆ
            - å¢åŠ é‡‘é¢å››èˆäº”å…¥å®¡è®¡æ—¥å¿—
            ```

            ## 4. å¢å¼ºç‰ˆè¾“å‡ºè§„èŒƒ

            ### 4.1 æ–‡æ¡£ç»“æ„

            ```markdown
            ## æµ‹è¯•è¿½è¸ªçŸ©é˜µ
            | éœ€æ±‚ID | æµ‹è¯•ç±»å‹ | ç”¨ä¾‹æ•° | è‡ªåŠ¨åŒ–ç‡ | éªŒæ”¶è¯æ® |
            |--------|----------|--------|----------|----------|

            ## ç¯å¢ƒæ‹“æ‰‘å›¾
            - æµ‹è¯•é›†ç¾¤é…ç½®ï¼š4C8G*3èŠ‚ç‚¹
            - ç‰¹æ®Šè®¾å¤‡ï¼šiOS/AndroidçœŸæœºæµ‹è¯•æ¶
            ```

            ### 4.2 ç”¨ä¾‹è®¾è®¡è§„èŒƒ

            ```markdown
            **TC-é£é™©åœºæ™¯éªŒè¯**ï¼š
            - ç ´åæ€§æµ‹è¯•æ­¥éª¤ï¼š
              1. æ¨¡æ‹Ÿç¬¬ä¸‰æ–¹APIè¿”å›500é”™è¯¯
              2. è¿ç»­å‘é€å¼‚å¸¸æŠ¥æ–‡10æ¬¡
            - é¢„æœŸéŸ§æ€§è¡¨ç°ï¼š
              - ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æœåŠ¡èŠ‚ç‚¹
              - è§¦å‘å‘Šè­¦é€šçŸ¥è¿ç»´äººå‘˜
            ```

            ## 5. æ™ºèƒ½å¢å¼ºæ¨¡å—

            ```markdown
            [!AIè¾…åŠ©æç¤º] å»ºè®®æ‰§è¡Œï¼š
            1. ä½¿ç”¨å†³ç­–è¡¨åˆ†æç™»å½•æ¨¡å—çš„ç»„åˆåœºæ™¯
            2. å¯¹æ ¸å¿ƒAPIè¿›è¡ŒSwaggerè§„èŒƒæ ¡éªŒ
            3. ç”Ÿæˆéœ€æ±‚è¦†ç›–ç‡çƒ­åŠ›å›¾ï¼ˆä½¿ç”¨JaCoCoï¼‰
            ```
            """,
            model_client_stream=True
        )

# åˆ›å»º QA å·¥ç¨‹å¸ˆä»£ç†ç”¨äºæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ
qa_agent = autogen.AssistantAgent(
    name="QA_Engineer",
    system_message="""ä½ æ˜¯ä¸€ä¸ªé«˜çº§æµ‹è¯•å·¥ç¨‹å¸ˆã€‚
    ä»»åŠ¡ï¼šæ ¹æ®ç»™å®šçš„åŠŸèƒ½ç‚¹ï¼Œç¼–å†™è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆåŒ…æ‹¬æ­£é¢å’Œåé¢åœºæ™¯ï¼‰ã€‚
    è§„åˆ™ï¼šå¯¹äºæ¯ä¸ªç¼–å†™çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¿…é¡»ç«‹å³è°ƒç”¨ 'save_testcase' å·¥å…·å°†å…¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚
    æ³¨æ„ï¼šç¡®ä¿ feature_id å‚æ•°æ­£ç¡®å¯¹åº”ã€‚""",
    llm_config=llm_config
)